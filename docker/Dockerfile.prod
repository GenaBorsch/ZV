# Production Dockerfile —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
FROM node:18-alpine AS base

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
RUN apk add --no-cache curl

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é pnpm –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
RUN npm install -g pnpm@8.15.9

# –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# Cache busting –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
ARG GIT_SHA=unknown
ARG BUILD_TIME=unknown
RUN echo "Building with GIT_SHA: $GIT_SHA at $BUILD_TIME"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ package.json —Ñ–∞–π–ª—ã –∏–∑ –≤—Å–µ—Ö –ø–∞–∫–µ—Ç–æ–≤
COPY apps/web/package.json ./apps/web/
COPY packages/db/package.json ./packages/db/
COPY packages/contracts/package.json ./packages/contracts/
COPY packages/ui/package.json ./packages/ui/
COPY packages/utils/package.json ./packages/utils/

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤–∫–ª—é—á–∞—è production dependencies)
# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Å frozen-lockfile, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º lockfile
RUN pnpm install --frozen-lockfile --prod=false || pnpm install --prod=false

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
RUN pnpm db:generate

# –°–æ–±–∏—Ä–∞–µ–º –ø–∞–∫–µ—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å —É—á–µ—Ç–æ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
RUN pnpm --filter contracts build || true
RUN pnpm --filter utils build || true

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ contracts —Å–æ–±—Ä–∞–Ω, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
RUN if [ ! -f "packages/contracts/dist/index.js" ]; then \
      mkdir -p packages/contracts/dist && \
      echo "export * from '../src/index';" > packages/contracts/dist/index.js; \
    fi

# –°–æ–±–∏—Ä–∞–µ–º db –ø–∞–∫–µ—Ç —Å fallback
RUN pnpm --filter db build || true

# –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ db dist —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
RUN if [ ! -f "packages/db/dist/index.js" ]; then \
      mkdir -p packages/db/dist && \
      echo "export * from '../src/index';" > packages/db/dist/index.js; \
    fi

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
RUN DATABASE_URL="postgresql://build:build@localhost:5432/build" \
    NEXTAUTH_SECRET="build-secret-32-chars-minimum" \
    NEXTAUTH_URL="http://localhost:80" \
    PUBLIC_BASE_URL="http://localhost:80" \
    S3_ENDPOINT="http://localhost:9000" \
    S3_ACCESS_KEY="build" \
    S3_SECRET_KEY="build" \
    PORT="80" \
    SKIP_ENV_VALIDATION=true \
    pnpm build

# Production —ç—Ç–∞–ø
FROM node:18-alpine AS runner
WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è health check
RUN apk add --no-cache curl

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ root –ø—Ä–∞–≤
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pnpm —Ç–æ–π –∂–µ –≤–µ—Ä—Å–∏–∏
RUN npm install -g pnpm@8.15.9

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
COPY --from=base --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=base --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=base --chown=nextjs:nodejs /app/apps/web/public ./apps/web/public

# –ö–æ–ø–∏—Ä—É–µ–º package.json –∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
COPY --from=base --chown=nextjs:nodejs /app/package.json ./
COPY --from=base --chown=nextjs:nodejs /app/packages/db ./packages/db
COPY --from=base --chown=nextjs:nodejs /app/packages/contracts ./packages/contracts
COPY --from=base --chown=nextjs:nodejs /app/packages/utils ./packages/utils
COPY --from=base --chown=nextjs:nodejs /app/node_modules ./node_modules

USER nextjs

# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π EXPOSE –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π PORT (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 80 –¥–ª—è EasyPanel)
ENV PORT=80
EXPOSE $PORT

ENV NODE_ENV=production
ENV HOSTNAME="0.0.0.0"

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
COPY --chown=nextjs:nodejs <<'EOF' /app/start.sh
#!/bin/sh
echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ó–≤—ë–∑–¥–Ω–æ–µ –í–µ—Ä–µ—Ç–µ–Ω–æ (Production)..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$DATABASE_URL" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  exit 1
fi

if [ -z "$NEXTAUTH_SECRET" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: NEXTAUTH_SECRET –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
  exit 1
fi

echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ë–î..."
if echo "$DATABASE_URL" | grep -q "postgresql://"; then
  echo "‚úÖ DATABASE_URL –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
else
  echo "‚ö†Ô∏è DATABASE_URL –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º: $DATABASE_URL"
fi

echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if ! pnpm --filter db migrate; then
  echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º..."
fi

echo "üåü –ó–∞–ø—É—Å–∫ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
exec node apps/web/server.js
EOF

RUN chmod +x /app/start.sh

# Health check - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é PORT –∏–ª–∏ 80 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:${PORT:-80}/api/health || exit 1

CMD ["/app/start.sh"]
